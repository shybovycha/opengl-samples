#include "irrlicht.h"
#include "fstream"
#include "stdlib.h"

#pragma comment(lib, "irrlicht.lib")

using namespace irr;
using namespace core;
using namespace scene;
using namespace video;
using namespace io;
using namespace gui;
using namespace std;

#define maxAmmo 10
#define maxTime 6000

int targetCnt = 0, Tm = maxTime, levelNumber = 0;
int points = 0, targetLeft = 0, ammo = maxAmmo;

bool endLevel = false;

char* maps[10];
char* targetfiles[10];

IGUIStaticText* indicator = 0;
ITimer* timer = 0;
IGUIWindow* msgbox = 0;

IrrlichtDevice *device = 0;
IVideoDriver* driver = 0;
ISceneManager* smgr = 0;
IGUIEnvironment* guienv = 0;
IAnimatedMesh* levelmesh = 0;
IAnimatedMeshSceneNode* level = 0;
ICameraSceneNode* camera = 0;

ISceneNode* target[10] = {0};

class EventReceiver : public IEventReceiver
{
    public:
        virtual bool OnEvent(const SEvent& event)
        {
            if (event.EventType == EET_GUI_EVENT)
            {
                if (event.GUIEvent.EventType == EGET_MESSAGEBOX_OK)
                {
                    if (endLevel == true)
                    {
                        endLevel = false;
                    }
                }
            }

            if (event.EventType == EET_KEY_INPUT_EVENT)
            {
                if (event.KeyInput.Key == KEY_ESCAPE)
                {
                    device->drop();

                    exit(0);
                }
            }

            if (event.EventType == EET_MOUSE_INPUT_EVENT)
            {
                if (event.MouseInput.Event == EMIE_LMOUSE_PRESSED_DOWN)
                {
                    ISceneNode* object = 0;

                    object = smgr->getSceneCollisionManager()->getSceneNodeFromCameraBB(camera);

                    if (ammo <= 0)
                        return false;

                    ammo--;

                    if (object == level)
                        return false;

                    object->setVisible(false);

                    points++;
                    targetLeft--;

                    return true;
                }

                if (event.MouseInput.Event == EMIE_RMOUSE_PRESSED_DOWN)
                {
                    if (ammo < maxAmmo)
                        ammo = maxAmmo;
                }
            }

            return false;
        }
};

EventReceiver receiver;

void init()
{
    device = createDevice(EDT_OPENGL, dimension2d<s32>(640, 480), 16,
			false, false, false, 0);

	device->setWindowCaption(L"ShootThem!");

	driver = device->getVideoDriver();
	smgr = device->getSceneManager();
	guienv = device->getGUIEnvironment();

	device->setEventReceiver(&receiver);
}

void createPlayer()
{
    camera = smgr->addCameraSceneNodeFPS(0, 100, 0, 0);
    device->getCursorControl()->setVisible(false);

    stringw str = L"Ammo: ";
    str += ammo;
    str += "/";
    str += maxAmmo;
    str += ";  Points: ";
    str += points;
    str += "/";
    str += targetCnt;

    indicator = guienv->addStaticText(str.c_str(), rect<s32>(10, 10, 260, 22), true);
    timer = device->getTimer();
    //timer->setSpeed(1000000);
    timer->start();
}

void loadConfig(char* filename)
{
    ifstream inf(filename);

    int mapCnt = -1;

    while (!inf.eof())
    {
        inf>>maps[++mapCnt];
        inf>>targetfiles[mapCnt];
    }

    inf.close();
}

void loadMap(char* mapname)
{
    levelmesh = smgr->getMesh(mapname);
    level = smgr->addAnimatedMeshSceneNode(levelmesh);

    smgr->addLightSceneNode(0, vector3df(0, 0, 0), SColorf(0.5f, 0.5f, 0.5f, 0), 50, 0);
}

void loadTargets(char* filename)
{
    ifstream inf(filename);

    vector3df pos;

    inf>>targetCnt;
    targetLeft = targetCnt;

    for (int i = 0; i <= targetCnt - 1; i++)
    {
        inf>>pos.X>>pos.Y>>pos.Z;

        target[i] = smgr->addSphereSceneNode(5.0f, 64, 0, i+1,
            pos, vector3df(0, 0, 0), vector3df(1, 1, 1));

        target[i]->setName("enemy");
    }

    inf.close();
}

void gotoMap(int mapNum)
{
    if (levelmesh != 0)
        levelmesh->drop();

    if (level != 0)
        level->drop();

    loadMap(maps[mapNum]);
    loadTargets(targetfiles[mapNum]);
}

void showResult()
{
    stringw title = L"Level complete!";
    stringw msg = L"Your time: ";

    msg += (maxTime - (Tm/100));
    msg += ";  Accuracy: ";
    msg += (points / targetCnt * 100);

    guienv->addMessageBox(title.c_str(), msg.c_str(), true, EMBF_OK, 0, 0);

    endLevel = true;

    timer->stop();
}

void refreshIndicator()
{
    stringw str = L"Ammo: ";
    str += ammo;
    str += "/";
    str += maxAmmo;
    str += ";  Points: ";
    str += points;
    str += "/";
    str += targetCnt;
    str += ";  Time:";
    str += (Tm/100);

    if (timer->isStopped() && endLevel == false)
    {
        Tm--;
    }

    if (Tm <= 0 || points == targetCnt)
        if (endLevel == false)
            showResult();

    indicator->setText(str.c_str());
}

int main()
{
    init();
    createPlayer();
    loadConfig("game.cfg");
    gotoMap(0);
    //loadMap("room.3ds");
    //loadTargets("target.cfg");

	while(device->run())
	if (device->isWindowActive())
	{
		driver->beginScene(true, true, SColor(0,200,200,200));

		smgr->drawAll();
		guienv->drawAll();

		refreshIndicator();

		//device->sleep(10, true);

		driver->endScene();
	}

	device->drop();

	timer->stop();

	return 0;
}

